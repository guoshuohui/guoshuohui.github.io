<!DOCTYPE html><html lang="zh-hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><title>Centos7 中安装 Sentry | HiWeb</title><meta name="description" content="- 前言服务器至少需要 2400M 的内存，安装 Sentry 之前请先部署好 Docker，参考 《Centos7 中安装 Docker 和 Docker Compose》 环境：  Centos 7.8 Python 3.6.8 Docker 20.10.1 Docker-Compose 1.17.4 Sentry 20.12.1  - 获取安装包到官方 GitHub 上获取最新版下载地址。本"><meta property="og:type" content="article"><meta property="og:title" content="Centos7 中安装 Sentry"><meta property="og:url" content="https://www.hiweb.cc/posts/installing-sentry-in-centos7/index.html"><meta property="og:site_name" content="HiWeb"><meta property="og:description" content="- 前言服务器至少需要 2400M 的内存，安装 Sentry 之前请先部署好 Docker，参考 《Centos7 中安装 Docker 和 Docker Compose》 环境：  Centos 7.8 Python 3.6.8 Docker 20.10.1 Docker-Compose 1.17.4 Sentry 20.12.1  - 获取安装包到官方 GitHub 上获取最新版下载地址。本"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2020-12-19T09:26:06.000Z"><meta property="article:modified_time" content="2020-12-19T09:26:06.000Z"><meta property="article:author" content="ShuoHui"><meta property="article:tag" content="hiweb,adonisjs,node,javascript,es6,vuejs,vue-cli3,weixin-miniprogram,server,full-stack"><meta name="twitter:card" content="summary"><link rel="icon" href="/favicon.ico"><link rel="alternate" href="/atom.xml" title="HiWeb" type="application/atom+xml"><link rel="stylesheet" href="/css/prism.css"><link rel="stylesheet" href="/css/app.css"></head><body><div class="container typo"><div class="article"><div class="head"><h1>Centos7 中安装 Sentry</h1><p><span>作者：ShuoHui</span><span>时间：2020-12-19</span> <span>分类：运维</span></p></div><div class="content"><h2 id="前言"><a href="#前言" class="headerlink" title="- 前言"></a>- 前言</h2><p>服务器至少需要 <code>2400M</code> 的内存，安装 Sentry 之前请先部署好 Docker，参考 <a href="/posts/installing-docker-in-centos7">《Centos7 中安装 Docker 和 Docker Compose》</a></p><p>环境：</p><ul><li>Centos 7.8</li><li>Python 3.6.8</li><li>Docker 20.10.1</li><li>Docker-Compose 1.17.4</li><li>Sentry 20.12.1</li></ul><h2 id="获取安装包"><a href="#获取安装包" class="headerlink" title="- 获取安装包"></a>- 获取安装包</h2><p>到官方 <a target="_blank" rel="noopener" href="https://github.com/getsentry/onpremise/releases">GitHub</a> 上获取最新版下载地址。本文安装的版本是 20.12.1。</p><p>cd 到你要下载安装包的目录，本文将其下载到 /data 目录下面，请自己创建和挂载数据盘。</p><p>1、安装 wget</p><pre><code class="language-bash">sudo yum install wget -y</code></pre><p>2、下载文件</p><pre><code class="language-bash">sudo mkdir /data
cd /data
sudo wget https://github.com/getsentry/onpremise/archive/20.12.1.tar.gz

# sudo wget -P /目录 地址</code></pre><p>3、解压文件</p><pre><code class="language-bash">sudo tar -zxvf 20.12.1.tar.gz</code></pre><p>4、进入安装目录</p><pre><code class="language-bash">cd onpremise-20.12.1</code></pre><h2 id="配置-env"><a href="#配置-env" class="headerlink" title="- 配置 .env"></a>- 配置 .env</h2><p>执行 <code>ll -a</code> 可以看到目录中有一个 .env 文件</p><pre><code class="language-bash">sudo vi .env

# 按 i 进入编辑模式</code></pre><p>将 SENTRY_EVENT_RETENTION_DAYS=90 改为 SENTRY_EVENT_RETENTION_DAYS=7，一般保存7天事件数据即可，视自己情况而定。在文件最后可添加 “限制 Kafka 磁盘使用量” 的配置，新版 Sentry 使用的 Kafka 会大量的写入日志信息，特别容易导致磁盘跑满，具体限制额度根据自己的磁盘情况而定。具体可常见 <a target="_blank" rel="noopener external nofollow noreferrer" href="https://forum.sentry.io/t/sentry-disk-cleanup-kafka/11337">Sentry disk cleanup [kafka]</a></p><pre><code class="language-bash">KAFKA_LOG_RETENTION_HOURS=24
KAFKA_LOG_RETENTION_BYTES=53687091200
KAFKA_LOG_SEGMENT_BYTES=1073741824
KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS=300000
KAFKA_LOG_SEGMENT_DELETE_DELAY_MS=60000</code></pre><p>编辑完成后，按 <code>esc</code> 退出编辑模式，然后按 <code>shift + :</code> 输入 <code>wq</code> 后回车。如果没有编辑可输入 <code>q</code> 或 <code>q!</code> 退出。</p><h2 id="开始安装"><a href="#开始安装" class="headerlink" title="- 开始安装"></a>- 开始安装</h2><p>新版的 Sentry 将在2021年1月之前停止对 Python 2 的支持，截止当前的最新版本依然支持 Python 2。如果你系统的 Python 版本是 2.x，会提示：Python 2 is no longer supported by the Python core team. Support for it is now deprecated in cryptography, and will be removed in the next release. 一般忽略即可。</p><p>1、执行安装脚本</p><pre><code class="language-bash">sudo ./install.sh</code></pre><blockquote><p>注意：如果提示 ERROR: Volume sentry-data declared as external, but could not be found. Please create the volume manually using <code>docker volume create --name=sentry-data</code> and try again. 等类似错误，请依次执行以下命令将对应目录挂载到容器，然后再重新执行以上安装脚本：</p></blockquote><pre><code class="language-bash">sudo docker volume create --name=sentry-data
sudo docker volume create --name=sentry-postgres
sudo docker volume create --name=sentry-redis
sudo docker volume create --name=sentry-zookeeper
sudo docker volume create --name=sentry-kafka
sudo docker volume create --name=sentry-clickhouse
sudo docker volume create --name=sentry-symbolicator</code></pre><blockquote><p>注意：如果安装失败，删除掉 onpremise-20.12.1 目录，然后重新解压 20.12.1.tar.gz 文件，再安装即可</p></blockquote><p>2、创建账号</p><p>安装过程末尾会提示 “Would you like to create a user account now”，输入一个邮箱和密码用于创建一个默认管理员账号</p><h3 id="启动服务"><a href="#启动服务" class="headerlink" title="- 启动服务"></a>- 启动服务</h3><p>最后安装完成会提示 “You’re all done! Run the following command to get Sentry running: docker-compose up -d”</p><pre><code class="language-bash">docker-compose up -d</code></pre><p>Sentry 服务会默认绑定到 9000 端口，宿主服务器的 Nginx 做一层 80 或 443 转发到 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://127.0.0.1:9000/">http://127.0.0.1:9000</a> 或 <a target="_blank" rel="noopener external nofollow noreferrer" href="http://localhost:9000/">http://localhost:9000</a> 即可，到此 Sentry 部署完成！</p><blockquote><p>注意：安装后 onpremise-20.12.1 目录不要删除，可能会导致服务重启失败！</p></blockquote><h2 id="其他常用命令"><a href="#其他常用命令" class="headerlink" title="- 其他常用命令"></a>- 其他常用命令</h2><pre><code class="language-bash"># 修改配置后，重启 Sentry
sudo docker-compose restart web worker cron sentry-cleanup

# 重启所有所有服务
sudo docker-compose restart</code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="- 参考"></a>- 参考</h2><p><a target="_blank" rel="noopener external nofollow noreferrer" href="https://develop.sentry.dev/self-hosted/">官方自托管Sentry部署文档</a></p></div><ul class="copyright"><li><strong>版权声明：</strong> <span>本站所有文章除特别声明外，均为原创，采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">BY-NC-SA </a>许可协议。转载请注明出处！</span></li></ul></div><div class="footer"><span>&copy;&nbsp;2020&nbsp;&nbsp;hiweb</span> 「 <a href="/">Home</a> <em>·</em> <a target="_blank" rel="noopener" href="https://github.com/guoshuohui">GitHub</a>」</div></div><script src="/js/prism.js"></script><script src="/js/app.js"></script></body></html>